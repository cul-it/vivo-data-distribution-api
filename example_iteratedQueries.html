<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-10-02 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Data Distribution API for VIVO &#x2013; Three sets of queries with slight variations</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                data-distribution-api-site
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-10-02</span>
                  &nbsp;| <span id="projectVersion">Version: 1.1.2-SNAPSHOT</span>
                      </div>
            <div class="xright">      
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="motivation.html" title="Why another API?">Why another API?</a>
            </li>
                  <li class="none">
                          <a href="structure.html" title="How does it work?">How does it work?</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_10.html" title="Install in VIVO 1.10">Install in VIVO 1.10</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_9.html" title="Install in VIVO 1.9">Install in VIVO 1.9</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_8.html" title="Install in VIVO 1.8">Install in VIVO 1.8</a>
            </li>
                  <li class="none">
                          <a href="configuration.html" title="Configuration">Configuration</a>
            </li>
                  <li class="none">
                          <a href="catalog.html" title="Implementations">Implementations</a>
            </li>
                  <li class="none">
                          <a href="examples.html" title="Examples from the wild">Examples from the wild</a>
            </li>
                  <li class="none">
                          <a href="cors.html" title="Cross-site distributions">Cross-site distributions</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
                  <li class="none">
                          <a href="release_notes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                      <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>Three sets of queries with slight variations</h1>
<p>The graphs visualization in <a class="externalLink" href="mailto:Scholars@Cornell">Scholars@Cornell</a> required a complex set of data.</p>

<ul>
  
<li>
<p>This could have been expressed as a twelve separate queries, consisting of three groups of almost identical queries; a maintenance headache.</p></li>
  
<li>
<p>Or, it could have been expressed as three queries with several UNION clauses among them. This could have been a maintenance headache or a performance headache, depending on the location of the UNIONs.</p></li>
  
<li>
<p>Instead it uses three <tt>IteratingGraphBuilder</tt> instances. Actually four, because two are nested together.</p></li>
</ul>
<p>An <tt>IteratingGraphBuilder</tt> is configured to create multiple instances of a <tt>GraphBuilder</tt>, each using the same query, but with one value changed in the parameter map. So, for example, <tt>builder_B</tt> will create three instances of <tt>builder_B1</tt>. </p>

<ul>
  
<li>The first instance receives a parameter map in which <tt>grantClass</tt> is set to <tt>vivo:Grant</tt>.</li>
  
<li>The second instance receives a parameter map in which <tt>grantClass</tt> is set to <tt>vivo:Contract</tt>.</li>
  
<li>The third instance receives a parameter map in which <tt>grantClass</tt> is set to <tt>vivo:CooperativeInvestigation</tt>.</li>
</ul>
<p><tt>builder_C</tt> does the same with three instances of <tt>builder_C1</tt>.</p>
<p><tt>builder_A</tt> takes this one step further, using three instances of <tt>builder_A1</tt> (another <tt>IteratingGraphBuilder</tt>) to create six instances of <tt>builder_A2</tt>. These six instances receive parameter maps with the following values (in addition to those from the request)</p>

<table border="0" class="bodyTable">
  <thead>
    
<tr class="a">
      
<th>instance </th>
      
<th>value of <tt>grantClass</tt> </th>
      
<th>value of <tt>investigatorRoleClass</tt></th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>1 </td>
      
<td><tt>vivo:Grant</tt> </td>
      
<td><tt>vivo:PrincipalInvestigatorRole</tt> </td>
    </tr>
    
<tr class="a">
      
<td>2 </td>
      
<td><tt>vivo:Grant</tt> </td>
      
<td><tt>vivo:CoPrincipalInvestigatorRole</tt> </td>
    </tr>
    
<tr class="b">
      
<td>3 </td>
      
<td><tt>vivo:Contract</tt> </td>
      
<td><tt>vivo:PrincipalInvestigatorRole</tt> </td>
    </tr>
    
<tr class="a">
      
<td>4 </td>
      
<td><tt>vivo:Contract</tt> </td>
      
<td><tt>vivo:CoPrincipalInvestigatorRole</tt> </td>
    </tr>
    
<tr class="b">
      
<td>5 </td>
      
<td><tt>vivo:CooperativeInvestigation</tt> </td>
      
<td><tt>vivo:PrincipalInvestigatorRole</tt> </td>
    </tr>
    
<tr class="a">
      
<td>6 </td>
      
<td><tt>vivo:CooperativeInvestigation</tt> </td>
      
<td><tt>vivo:CoPrincipalInvestigatorRole</tt> </td>
    </tr>
  </tbody>
</table>
<p>The results of all of these queries are merged into a single in-memory model, and the <tt>SelectFromGraphDistributor</tt> runs a SELECT query against that model, and serves the result.</p>
<p><img src="images/example_iteratedQueries.png" alt="Instances and data flow" /></p>
<div class="section">
<h2><a name="Equivalent_options"></a>Equivalent options</h2>
<p>The configuration could have been restructured as shown below. This is effectively equivalent, both in terms of performance and maintenance. There is no obvious reason to prefer one over the other, except for clarity, which is subject to debate.</p>
<p><img src="images/example_iteratedQueries_again.png" alt="Instances and data flow" /></p></div>
<div class="section">
<h2><a name="Performance"></a>Performance</h2>
<p>Even when broken down into simple queries, the time taken by this distributor was prohibitive. In a development environment, the query ran for more than 45 seconds. It was never deployed to production.</p>
<p>Instead, the query was run in a batch job, and the results were cached, as described in <a href="./example_cacheingForPerformance.html">Cacheing for Performance</a>.</p></div>
<div class="section">
<h2><a name="The_configuration"></a>The configuration</h2>

<div class="source">
<div class="source">
<pre>@prefix : &lt;http://vitro.mannlib.cornell.edu/ns/vitro/ApplicationSetup#&gt; .
@prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .
@prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt; .

#
# Grants data:
#
# Twelve construct queries and a select query. 
#
# The first six construct queries handle the combinations of 
# Grant/Contract/CooperativeInvestigation and PrincipalInvestigator/CoPrincipalInvestigator. 
# The six separate queries run much more quickly than a single query using UNIONs or FILTERs. 
# 
# The remaining six construct queries provide two sets of optional data for 
# Grant/Contract/CooperativeInvestigation.
#
# The select query creates a result set from the graph built by the construct queries.
#

:ddgrants
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.DataDistributor&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.SelectFromGraphDistributor&gt; ;
    :actionName &quot;grants_bubble_chart_cache&quot; ;
    :graphBuilder :builder_A ;
    :graphBuilder :builder_B ;
    :graphBuilder :builder_C ;
    :query &quot;&quot;&quot;
      PREFIX local:          &lt;http://scholars.cornell.edu/individual/&gt;
      PREFIX obo:            &lt;http://purl.obolibrary.org/obo/&gt;
      PREFIX rdfs:           &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
      PREFIX scholars-grant: &lt;http://scholars.cornell.edu/ontology/grant.owl#&gt;
      PREFIX scholars-hr:    &lt;http://scholars.cornell.edu/ontology/hr.owl#&gt;
      PREFIX vivo:           &lt;http://vivoweb.org/ontology/core#&gt;
      
      SELECT ?grant ?grantTitle ?grantId ?type
             ?amount ?fundingOrg ?fundingOrgName
             ?person ?personName ?personNetid ?role
             ?dept ?deptName
             ?startdt ?enddt
      
      WHERE {
        ?grant a ?type .
        ?grant rdfs:label ?grantTitle .
        ?grant vivo:localAwardId ?grantId .
        ?grant vivo:totalAwardAmount ?amount .
        OPTIONAL {
          ?grant vivo:assignedBy ?fundingOrg .
          ?fundingOrg rdfs:label ?fundingOrgName .
        }
       
        ?grant vivo:relates ?node1 .
        ?node1 a ?role .
        ?node1 obo:RO_0000052 ?person .
        ?person rdfs:label ?personName .
        ?person scholars-hr:netId ?personNetid .
      
        OPTIONAL {
          ?grant vivo:relates ?node2 .
          ?node2 a vivo:AdministratorRole .
          ?node2 obo:RO_0000052 ?dept .
          ?dept rdfs:label ?deptName .
        }
        
        ?grant vivo:dateTimeInterval ?dti .
        ?dti vivo:end ?end .
        ?end vivo:dateTime ?enddt .
        ?dti vivo:start ?start .
        ?start vivo:dateTime ?startdt .
      }
      &quot;&quot;&quot; .
      
:builder_A
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.IteratingGraphBuilder&gt; ;
    :parameterName &quot;grantClass&quot; ;
    :parameterValue 
        &quot;http://vivoweb.org/ontology/core#Grant&quot;, 
        &quot;http://vivoweb.org/ontology/core#Contract&quot;, 
        &quot;http://vivoweb.org/ontology/core#CooperativeInvestigation&quot; ;
    :childGraphBuilder :builder_A1 .

:builder_A1
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.IteratingGraphBuilder&gt; ;
    :parameterName &quot;investigatorRoleClass&quot; ;
    :parameterValue 
        &quot;http://vivoweb.org/ontology/core#PrincipalInvestigatorRole&quot;, 
        &quot;http://vivoweb.org/ontology/core#CoPrincipalInvestigatorRole&quot;;
    :childGraphBuilder :builder_A2 .

:builder_A2
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder&gt; ;
    :uriBinding &quot;grantClass&quot; ;
    :uriBinding &quot;investigatorRoleClass&quot; ;
    :constructQuery &quot;&quot;&quot;
      PREFIX obo:            &lt;http://purl.obolibrary.org/obo/&gt;
      PREFIX rdfs:           &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
      PREFIX scholars-grant: &lt;http://scholars.cornell.edu/ontology/grant.owl#&gt;
      PREFIX scholars-hr:    &lt;http://scholars.cornell.edu/ontology/hr.owl#&gt;
      PREFIX vivo:           &lt;http://vivoweb.org/ontology/core#&gt;
 
      CONSTRUCT {     
        ?grant a ?grantClass .
        ?grant vivo:relates ?roleNode .
        ?roleNode a ?investigatorRoleClass .

        ?grant rdfs:label ?grantTitle .
        ?grant vivo:localAwardId ?grantId .
        ?grant vivo:totalAwardAmount ?amount .
       
        ?roleNode obo:RO_0000052 ?person .
        ?person rdfs:label ?personName .
        ?person scholars-hr:netId ?personNetid .
       
        ?grant vivo:dateTimeInterval ?dti .
        ?dti vivo:end ?end .
        ?end vivo:dateTime ?enddt .
        ?dti vivo:start ?start .
        ?start vivo:dateTime ?startdt .
      } 
      WHERE {
        ?grant a ?grantClass .
        ?grant vivo:relates ?roleNode .
        ?roleNode a ?investigatorRoleClass .

        ?grant rdfs:label ?grantTitle .
        ?grant vivo:localAwardId ?grantId .
        ?grant vivo:totalAwardAmount ?amount .
       
        ?roleNode obo:RO_0000052 ?person .
        ?person rdfs:label ?personName .
        ?person scholars-hr:netId ?personNetid .
       
        ?grant vivo:dateTimeInterval ?dti .
        ?dti vivo:end ?end .
        ?end vivo:dateTime ?enddt .
        ?dti vivo:start ?start .
        ?start vivo:dateTime ?startdt .
      }
      &quot;&quot;&quot; .
      
:builder_B
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.IteratingGraphBuilder&gt; ;
    :parameterName &quot;grantClass&quot; ;
    :parameterValue 
        &quot;http://vivoweb.org/ontology/core#Grant&quot;, 
        &quot;http://vivoweb.org/ontology/core#Contract&quot;, 
        &quot;http://vivoweb.org/ontology/core#CooperativeInvestigation&quot; ;
    :childGraphBuilder :builder_B1 .

:builder_B1
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder&gt; ;
    :uriBinding &quot;grantClass&quot; ;
    :constructQuery &quot;&quot;&quot;
      PREFIX rdfs:           &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
      PREFIX vivo:           &lt;http://vivoweb.org/ontology/core#&gt;
 
      CONSTRUCT {     
        ?grant a ?grantClass .
        ?grant vivo:assignedBy ?fundingOrg .
        ?fundingOrg rdfs:label ?fundingOrgName .
      } 
      WHERE {
        ?grant a ?grantClass .
        ?grant vivo:assignedBy ?fundingOrg .
        ?fundingOrg rdfs:label ?fundingOrgName .
      }
      &quot;&quot;&quot; .
      
:builder_C
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.IteratingGraphBuilder&gt; ;
    :parameterName &quot;grantClass&quot; ;
    :parameterValue 
        &quot;http://vivoweb.org/ontology/core#Grant&quot;, 
        &quot;http://vivoweb.org/ontology/core#Contract&quot;, 
        &quot;http://vivoweb.org/ontology/core#CooperativeInvestigation&quot; ;
    :childGraphBuilder :builder_C1 .

:builder_C1
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder&gt; ;
    :uriBinding &quot;grantClass&quot; ;
    :constructQuery &quot;&quot;&quot;
      PREFIX obo:            &lt;http://purl.obolibrary.org/obo/&gt;
      PREFIX rdfs:           &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
      PREFIX vivo:           &lt;http://vivoweb.org/ontology/core#&gt;
 
      CONSTRUCT {     
        ?grant a ?grantClass .
        ?grant vivo:relates ?node2 .
        ?node2 a vivo:AdministratorRole .
        ?node2 obo:RO_0000052 ?dept .
        ?dept rdfs:label ?deptName .
      } 
      WHERE {
        ?grant a ?grantClass .
        ?grant vivo:relates ?node2 .
        ?node2 a vivo:AdministratorRole .
        ?node2 obo:RO_0000052 ?dept .
        ?dept rdfs:label ?deptName .
      }
      &quot;&quot;&quot; .

</pre></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2018.
          All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
