<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-10-02 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Data Distribution API for VIVO &#x2013; Drilldown with multiple queries, wrapped in a Javascript formatter</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                data-distribution-api-site
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-10-02</span>
                  &nbsp;| <span id="projectVersion">Version: 1.1.2-SNAPSHOT</span>
                      </div>
            <div class="xright">      
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="motivation.html" title="Why another API?">Why another API?</a>
            </li>
                  <li class="none">
                          <a href="structure.html" title="How does it work?">How does it work?</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_10.html" title="Install in VIVO 1.10">Install in VIVO 1.10</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_9.html" title="Install in VIVO 1.9">Install in VIVO 1.9</a>
            </li>
                  <li class="none">
                          <a href="install_vivo_1_8.html" title="Install in VIVO 1.8">Install in VIVO 1.8</a>
            </li>
                  <li class="none">
                          <a href="configuration.html" title="Configuration">Configuration</a>
            </li>
                  <li class="none">
                          <a href="catalog.html" title="Implementations">Implementations</a>
            </li>
                  <li class="none">
                          <a href="examples.html" title="Examples from the wild">Examples from the wild</a>
            </li>
                  <li class="none">
                          <a href="cors.html" title="Cross-site distributions">Cross-site distributions</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
                  <li class="none">
                          <a href="release_notes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                      <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                    <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>Drilldown with multiple queries, wrapped in a Javascript formatter</h1>
<p>This distributor produces a JSON-formatted list of information about the publications written by a given faculty member. The HTTP request must specify a <tt>person</tt> parameter, containing the URI of the faculty member.</p>
<p>This is two distributors: an <tt>RdfGraphDistributor</tt> wrapped in a <tt>JavaScriptTransformDistributor</tt>.</p>
<p>The <tt>RdfGraphDistributor</tt> uses a structure of <tt>GraphBuilder</tt> instances to produce a model which is emitted in Turtle format. The <tt>JavaScriptTransformDistributor</tt> uses a Javascript (with two supporting scripts) to convert that Turtle output into JSON format, structured according to the user requirements.</p>
<p>The <tt>RdfGraphDistributor</tt> uses a <tt>DrillDownGraphBuilder</tt> to create its model. The <tt>DrillDownGraphBuilder</tt> runs a <tt>ConstructQueryGraphBuilder</tt> to produce a small model, and applies a SELECT query to that model to produce a list of URIs for the publications of the faculty member.</p>
<p>Then, the <tt>DrillDownGraphBuilder</tt> creates and runs a <tt>ConstructQueryGraphBuilder</tt> for each publication in the list, adding the results of each <tt>ConstructQueryGraphBuilder</tt> to the model. If this weren&#x2019;t already complex enough, each of these <tt>ConstructQueryGraphBuilder</tt> instances runs several CONSTRUCT queries for the URL it is applied to. These simple CONSTRUCT queries run more quickly than a large complex query with many OPTIONAL or UNION clauses.</p>
<p>Once all of these <tt>GraphBuilder</tt>s have been run, and their results have been added to the model, and the model has been output in Turtle format, then the <tt>JavaScriptTransformDistributor</tt> goes to work. It defines a <tt>transform()</tt> function which receives the Turtle as a string, converts it to JSON, and returns that JSON as output. The <tt>transform()</tt> function relies on functions in the supporting scripts to do much of its work.</p>
<p>Final result: a JSON stream with the desired data and structure.</p>
<p><img src="images/example_drilldownAndFormatting.png" alt="Instances and data flow" /></p>

<div class="source">
<div class="source">
<pre>#
# ------------------------------------------------------------------------------
#
# Get a JSON formatted list of publications for a specific person.
#
# Run an inner data distributor that creates a TURTLE file for the result, and 
# wrap it in a decorator that convewrts the TURTLE to JSON.
#
# Play games with the inner distributor, including drill-down and multiple 
# sub-queries, to try to speed it up.
# 
# ------------------------------------------------------------------------------
#
 
@prefix : &lt;http://vitro.mannlib.cornell.edu/ns/vitro/ApplicationSetup#&gt; .

#
# The inner distributor uses a GraphBuilder and converts the result to TURTLE.
#

:publist_inner
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.DataDistributor&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.RdfGraphDistributor&gt; ;
    :actionName &quot;_none_&quot; ;
    :graphBuilder :publist_driller .

#
# the GraphBuilder gets the publications for the person, and then drills down 
# to get the information for each publication.
#    
:publist_driller
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.DrillDownGraphBuilder&gt; ;
    :topLevelGraphBuilder :publist_drill_top ;
    :childGraphBuilder :publist_drill_bottom ;
    :drillDownQuery &quot;&quot;&quot;
        PREFIX bibo: &lt;http://purl.org/ontology/bibo/&gt;
        SELECT ?pub
        WHERE {
          ?pub a bibo:Document .
        }
    &quot;&quot;&quot; .

:publist_drill_top
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder&gt; ;
    :uriBinding &quot;person&quot; ;
    :constructQuery &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX bibo:     &lt;http://purl.org/ontology/bibo/&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub a bibo:Document .
          ?pub rdfs:label ?pubLabel .
        }
        WHERE
        {
          ?person vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:relates ?pub .
          ?pub a bibo:Document .
          ?pub rdfs:label ?pubLabel .
        }
    &quot;&quot;&quot; .

#
# For each publication, run a group of queries, rather than one query with
# multiple OPTIONAL or UNION clauses.
#
    
:publist_drill_bottom
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder&gt; ;
    :uriBinding &quot;pub&quot; ;
    :constructQuery &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX foaf:     &lt;http://xmlns.com/foaf/0.1/&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:relatedBy ?auth .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?author .
          ?author a foaf:Person .
          ?author rdfs:label ?authorName .
        }
        WHERE
        {
          ?pub vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?author .
          ?author a foaf:Person .
          ?author rdfs:label ?authorName .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX vcard:    &lt;http://www.w3.org/2006/vcard/ns#&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:relatedBy ?auth .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vcard:givenName ?givenName .
        }
        WHERE
        {
          ?pub vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vcard:givenName ?givenName .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX vcard:    &lt;http://www.w3.org/2006/vcard/ns#&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:relatedBy ?auth .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vivo:middleName ?middleName .
        }
        WHERE
        {
          ?pub vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vivo:middleName ?middleName .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX vcard:    &lt;http://www.w3.org/2006/vcard/ns#&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:relatedBy ?auth .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vcard:familyName ?familyName .
        }
        WHERE
        {
          ?pub vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:rank ?rank .
          ?auth vivo:relates ?vcard .
          ?vcard vcard:hasName ?vname .
          ?vname vcard:familyName ?familyName .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:dateTimeValue ?timeStamp .
          ?timeStamp vivo:dateTime ?dateTime .
        }
        WHERE
        {
          ?pub vivo:dateTimeValue ?timeStamp .
          ?timeStamp vivo:dateTime ?dateTime .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX rdfs:     &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
        PREFIX vivo:     &lt;http://vivoweb.org/ontology/core#&gt;
        CONSTRUCT {
          ?pub vivo:hasPublicationVenue ?journal .
          ?journal rdfs:label ?journalName .
        }
        WHERE
        {
          ?pub vivo:hasPublicationVenue ?journal .
          ?journal rdfs:label ?journalName .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX bibo:     &lt;http://purl.org/ontology/bibo/&gt;
        CONSTRUCT {
          ?pub bibo:doi ?doi .
        }
        WHERE
        {
          ?pub bibo:doi ?doi .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX bibo:     &lt;http://purl.org/ontology/bibo/&gt;
        CONSTRUCT {
          ?pub bibo:volume ?volume .
        }
        WHERE
        {
          ?pub bibo:volume ?volume .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX bibo:     &lt;http://purl.org/ontology/bibo/&gt;
        CONSTRUCT {
          ?pub bibo:issue ?issue .
        }
        WHERE
        {
          ?pub bibo:issue ?issue .
        }
    &quot;&quot;&quot; , &quot;&quot;&quot;
        PREFIX bibo:     &lt;http://purl.org/ontology/bibo/&gt;
        CONSTRUCT {
          ?pub bibo:pageStart ?pageStart .
          ?pub bibo:pageEnd ?pageEnd .
        }
        WHERE
        {
          ?pub bibo:pageStart ?pageStart .
          ?pub bibo:pageEnd ?pageEnd .
        }
    &quot;&quot;&quot; .    

#
# The decorator converts the TURTLE RDF model into a JSON structure.
#
:publist_distributor
    a   &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.DataDistributor&gt; ,
        &lt;java:edu.cornell.library.scholars.webapp.controller.api.distribute.decorator.JavaScriptTransformDistributor&gt; ;
    :actionName &quot;listPublications&quot; ;
    :contentType &quot;application/json&quot; ;
    :child :publist_inner ;
    :supportingScript &quot;/js/scholars-vis/rdflib.js&quot;;
    :supportingScript &quot;/js/scholars-vis/rdf-helper-methods.js&quot;;
    :script &quot;&quot;&quot;
        function transform(turtleRdf) {
            var graph = populateGraph(turtleRdf);
            standardPrefixes();
            
            var results = [];
            getPubStatements().forEach(processPublication);
            
            return JSON.stringify(results, null, 2);
                
            function processPublication(stmt) {
                var pubNode = stmt.subject;
 
                var result = { uri: pubNode.uri };
                addRequiredField(result, &quot;label&quot;, findPublicationName);
                addRequiredField(result, &quot;authors&quot;, findAuthors);
                addOptionalField(result, &quot;pubDate&quot;, findPubDate);
                addOptionalField(result, &quot;journalName&quot;, findJournalName);
                addOptionalField(result, &quot;doi&quot;, findDoi);
                addOptionalField(result, &quot;volume&quot;, findVolume);
                addOptionalField(result, &quot;issue&quot;, findIssue);
                addOptionalField(result, &quot;pages&quot;, findPages);
                results.push(result);
                    
                function findPublicationName() {
                    return getAnyValue(graph, pubNode, RDFS('label'));
                }
                
                function findAuthors() {
                    return findAuthorshipNodes().map(getAuthorInfo).sort(rankSorter);
                    
                    function findAuthorshipNodes() {
                        return graph.each(pubNode, VIVO('relatedBy'));
                    }
                    
                    function getAuthorInfo(authorshipNode) {
                        var rank = parseInt(getAnyValue(graph, authorshipNode, VIVO('rank')));
                        var authorNode = graph.any(authorshipNode, VIVO('relates'));
                        
                        if (authorIsPerson()) {
                            return personAuthorInfo();
                        } else {
                            return vcardAuthorInfo();
                        }
                        
                        function authorIsPerson() {
                            return graph.statementsMatching(authorNode, RDF('type'), FOAF('Person')).length &gt; 0;
                        }
                        
                        function personAuthorInfo() {
                            return {
                                rank: rank,
                                label: getAnyValue(graph, authorshipNode, VIVO('relates'), RDFS('label'))
                            };
                        }
                        
                        function vcardAuthorInfo() {
                            var firstName = findVCardFirstName();
                            var middleName = findVCardMiddleName();
                            var lastName = findVCardLastName();
                            return {
                                rank: rank,
                                label: combineNameParts()
                            }
                            
                            function findVCardFirstName() {
                                return getAnyValue(graph, authorNode, VCARD('hasName'), VCARD('givenName'));
                            }

                            function findVCardMiddleName() {
                                return getAnyValue(graph, authorNode, VCARD('hasName'), VIVO('middleName'));
                            }

                            function findVCardLastName() {
                                return getAnyValue(graph, authorNode, VCARD('hasName'), VCARD('familyName'));
                            }
                            
                            function combineNameParts() {
                                if (!lastName) {
                                    return &quot;NO NAME&quot;;
                                }
                                var name = lastName;
                                
                                if (firstName || middleName) {
                                    name += &quot;,&quot;;
                                }
                                if (firstName) {
                                    name += &quot; &quot; + firstName;
                                    if (firstName.length == 1) {
                                        name += &quot;.&quot;;
                                    }
                                }
                                if (middleName) {
                                    name += &quot; &quot; + middleName;
                                    if (middleName.length == 1) {
                                        name += &quot;.&quot;;
                                    }
                                }
                                return name;
                            }
                        }
                        
                    }

                    function rankSorter(a, b) {
                        return a.rank - b.rank;
                    }
                    
                }
                
                function findPubDate() {
                    return getAnyValue(graph, pubNode, VIVO('dateTimeValue'), VIVO('dateTime')).substring(0, 4);
                }
                
                function findJournalName() {
                    return getAnyValue(graph, pubNode, VIVO('hasPublicationVenue'), RDFS('label'));
                }
                
                function findDoi() {
                    return getAnyValue(graph, pubNode, BIBO('doi'));
                }

                function findVolume() {
                    return getAnyValue(graph, pubNode, BIBO('volume'))
                }

                function findIssue() {
                    return getAnyValue(graph, pubNode, BIBO('issue'))
                }
                
                function findPages() {
                    var pageStart = getAnyValue(graph, pubNode, BIBO('pageStart'));
                    var pageEnd = getAnyValue(graph, pubNode, BIBO('pageEnd'));
                    if (pageStart == null &amp;&amp; pageEnd == null) {
                        return null;
                    } else {
                        return {
                            pageStart: pageStart,
                            pageEnd: pageEnd
                        }
                    }
                }
            }
                
            function getPubStatements() {
                return graph.statementsMatching(undefined, RDF('type'), BIBO('Document'));
            }
        }
    &quot;&quot;&quot; .

</pre></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2018.
          All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
